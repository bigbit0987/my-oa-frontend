<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" 
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" 
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" 
             xmlns:flowable="http://flowable.org/bpmn" 
             targetNamespace="http://www.company.com/workflow" 
             exporter="Camunda Modeler" 
             exporterVersion="5.41.0">

  <process id="project_change_application_process" name="项目变更申请流程" isExecutable="true">
    <documentation>
      手动发起 - 项目变更申请（适用于：项目名称变更、编号变更、人员变更、工期变更等）
      流程说明：项目负责人填写变更申请 -> 部门审批 -> 院领导审批（根据变更类型）
    </documentation>

    <startEvent id="startEvent" name="开始" flowable:initiator="initiator" />
    
    <sequenceFlow id="flow_start_to_pm" sourceRef="startEvent" targetRef="task_pm_apply" />

    <userTask id="task_pm_apply" name="项目负责人填写变更申请" flowable:assignee="${initiator}" flowable:formKey="project_change_application">
      <documentation>项目负责人填写变更类型、变更原因、原值与新值</documentation>
    </userTask>

    <sequenceFlow id="flow_pm_to_dept" sourceRef="task_pm_apply" targetRef="task_dept_approve" />

    <userTask id="task_dept_approve" name="部门审批" flowable:candidateGroups="DEPT_ADMIN" flowable:formKey="project_change_application">
      <documentation>部门审批变更申请</documentation>
    </userTask>

    <sequenceFlow id="flow_dept_to_gateway" sourceRef="task_dept_approve" targetRef="gateway_need_leader" />

    <exclusiveGateway id="gateway_need_leader" name="是否需要院领导审批?" />

    <sequenceFlow id="flow_need_leader" name="需要" sourceRef="gateway_need_leader" targetRef="task_leader_approve">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${vars:getOrDefault('needLeaderApproval', 'no') == 'yes'}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow_no_leader" name="不需要" sourceRef="gateway_need_leader" targetRef="endEvent">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${vars:getOrDefault('needLeaderApproval', 'no') != 'yes'}]]></conditionExpression>
    </sequenceFlow>

    <userTask id="task_leader_approve" name="院领导审批" flowable:candidateGroups="INSTITUTE_LEADER" flowable:formKey="project_change_application">
      <documentation>院领导审批变更申请</documentation>
    </userTask>

    <sequenceFlow id="flow_leader_to_end" sourceRef="task_leader_approve" targetRef="endEvent" />

    <endEvent id="endEvent" name="结束" />

  </process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_change">
    <bpmndi:BPMNPlane id="BPMNPlane_change" bpmnElement="project_change_application_process">
      <bpmndi:BPMNShape id="shape_startEvent" bpmnElement="startEvent">
        <omgdc:Bounds x="100" y="200" width="30" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_pm_apply" bpmnElement="task_pm_apply">
        <omgdc:Bounds x="180" y="185" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_dept_approve" bpmnElement="task_dept_approve">
        <omgdc:Bounds x="330" y="185" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_gateway_need_leader" bpmnElement="gateway_need_leader" isMarkerVisible="true">
        <omgdc:Bounds x="480" y="195" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_leader_approve" bpmnElement="task_leader_approve">
        <omgdc:Bounds x="580" y="100" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_endEvent" bpmnElement="endEvent">
        <omgdc:Bounds x="700" y="200" width="28" height="28" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
