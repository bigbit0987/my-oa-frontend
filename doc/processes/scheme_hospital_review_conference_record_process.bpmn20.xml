<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" 
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" 
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" 
             xmlns:flowable="http://flowable.org/bpmn" 
             targetNamespace="http://www.company.com/workflow" 
             exporter="Camunda Modeler" 
             exporterVersion="5.41.0">

  <process id="scheme_hospital_review_conference_record_process" name="方案院审会记录流程" isExecutable="true">
    <documentation>
      方案审查阶段 - 院审会记录表（自动触发，院审申请通过后触发）
      流程说明：技术办助理填写意见 -> 主持人确认 -> 缺席人员补充意见 -> 项目负责人上传归档附件
    </documentation>

    <startEvent id="startEvent" name="开始" flowable:initiator="initiator" />
    
    <sequenceFlow id="flow_start_to_tech" sourceRef="startEvent" targetRef="task_tech_assistant_fill" />

    <userTask id="task_tech_assistant_fill" name="技术办助理填写意见" flowable:candidateGroups="TECH_OFFICE" flowable:formKey="scheme_hospital_review_conference_record">
      <documentation>技术办助理填写院审会意见、记录参会人员及意见</documentation>
    </userTask>

    <sequenceFlow id="flow_tech_to_host" sourceRef="task_tech_assistant_fill" targetRef="task_host_confirm" />

    <userTask id="task_host_confirm" name="主持人确认" flowable:assignee="${hostId}" flowable:formKey="scheme_hospital_review_conference_record">
      <documentation>主持人确认审批技术办助理填写的意见是否准确无误</documentation>
    </userTask>

    <sequenceFlow id="flow_host_to_gateway" sourceRef="task_host_confirm" targetRef="gateway_check_absent" />

    <exclusiveGateway id="gateway_check_absent" name="是否有人缺席?" />

    <sequenceFlow id="flow_has_absent" name="有缺席" sourceRef="gateway_check_absent" targetRef="task_absent_supplement">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${vars:getOrDefault('hasAbsentee', 'no') == 'yes'}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flow_no_absent" name="无缺席" sourceRef="gateway_check_absent" targetRef="task_pm_upload">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${vars:getOrDefault('hasAbsentee', 'no') != 'yes'}]]></conditionExpression>
    </sequenceFlow>

    <userTask id="task_absent_supplement" name="缺席人员补充意见" flowable:candidateUsers="${absentUserIds}" flowable:formKey="scheme_hospital_review_conference_record">
      <documentation>项目主管/项目审核缺席时，在指定时间内补充意见</documentation>
      <extensionElements>
        <flowable:taskListener event="create" class="org.flowable.engine.impl.bpmn.listener.DueDateTaskListener">
          <flowable:field name="dueDate"><flowable:string>P3D</flowable:string></flowable:field>
        </flowable:taskListener>
      </extensionElements>
    </userTask>

    <sequenceFlow id="flow_absent_to_tech_reconfirm" sourceRef="task_absent_supplement" targetRef="task_tech_reconfirm" />

    <userTask id="task_tech_reconfirm" name="技术办确认补充意见" flowable:candidateGroups="TECH_OFFICE" flowable:formKey="scheme_hospital_review_conference_record">
      <documentation>技术办助理确认缺席人员补充的意见</documentation>
    </userTask>

    <sequenceFlow id="flow_tech_reconfirm_to_pm" sourceRef="task_tech_reconfirm" targetRef="task_pm_upload" />

    <userTask id="task_pm_upload" name="项目负责人上传附件" flowable:assignee="${initiator}" flowable:formKey="scheme_hospital_review_conference_record">
      <documentation>项目负责人上传方案附件归档</documentation>
    </userTask>

    <sequenceFlow id="flow_pm_to_end" sourceRef="task_pm_upload" targetRef="endEvent" />

    <endEvent id="endEvent" name="结束" />

  </process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_scheme_hospital_conf">
    <bpmndi:BPMNPlane id="BPMNPlane_scheme_hospital_conf" bpmnElement="scheme_hospital_review_conference_record_process">
      <bpmndi:BPMNShape id="shape_startEvent" bpmnElement="startEvent">
        <omgdc:Bounds x="100" y="200" width="30" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_tech_assistant_fill" bpmnElement="task_tech_assistant_fill">
        <omgdc:Bounds x="180" y="185" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_host_confirm" bpmnElement="task_host_confirm">
        <omgdc:Bounds x="330" y="185" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_gateway_check_absent" bpmnElement="gateway_check_absent" isMarkerVisible="true">
        <omgdc:Bounds x="480" y="195" width="40" height="40" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_absent_supplement" bpmnElement="task_absent_supplement">
        <omgdc:Bounds x="580" y="100" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_tech_reconfirm" bpmnElement="task_tech_reconfirm">
        <omgdc:Bounds x="730" y="100" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_task_pm_upload" bpmnElement="task_pm_upload">
        <omgdc:Bounds x="880" y="185" width="100" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_endEvent" bpmnElement="endEvent">
        <omgdc:Bounds x="1030" y="200" width="28" height="28" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
